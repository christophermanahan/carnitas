package io.github.christophermanahan.carnitas;

import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.Test;

import java.io.IOException;
import java.net.ServerSocket;

class WhileOpenTest {
    @Test
    void itWillRunRunnableWhileOpen() throws IOException {
        int calls = 3;
        RunContext context = new WhileOpen(new OpenCloseServerSocket(calls));
        ContextRunnable runnable = new ContextRunnable();

        context.accept(runnable);

        Assertions.assertEquals(calls, runnable.ran);
    }

    private class OpenCloseServerSocket extends ServerSocket {
        private final int calls;
        private int called;

        OpenCloseServerSocket(int calls) throws IOException {
            super();
            this.calls = calls;
            this.called = -1;
        }

        public boolean isClosed() {
            called++;
            return calls == called;
        }
    }

    private class ContextRunnable implements Runnable {
        int ran;

        ContextRunnable() {
            this.ran = 0;
        }

        public void run() {
            ran++;
        }
    }
}
